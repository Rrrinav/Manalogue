<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>man search</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,300;0,400;0,600;1,300&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:        #0d0d0d;
    --bg2:       #111111;
    --bg3:       #181818;
    --border:    #2a2a2a;
    --amber:     #ffb347;
    --amber-dim: #7a5520;
    --green:     #39ff7e;
    --red:       #ff4f4f;
    --text:      #d4c9b0;
    --muted:     #5a5248;
    --bright:    #fffdf7;
  }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 14px;
    overflow: hidden;
  }

  /* Scanline overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.06) 2px,
      rgba(0,0,0,0.06) 4px
    );
    pointer-events: none;
    z-index: 1000;
  }

  /* Vignette */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at center, transparent 55%, rgba(0,0,0,0.7) 100%);
    pointer-events: none;
    z-index: 999;
  }

  .layout {
    display: grid;
    grid-template-columns: 360px 1fr;
    grid-template-rows: 100vh;
    height: 100vh;
  }

  /* ── LEFT PANEL ── */
  .left {
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
    background: var(--bg2);
    overflow: hidden;
  }

  .header {
    padding: 28px 24px 20px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 22px;
    letter-spacing: -0.5px;
    color: var(--bright);
    display: flex;
    align-items: baseline;
    gap: 6px;
  }

  .logo .man { color: var(--amber); }
  .logo .slash { color: var(--muted); font-weight: 300; }

  .tagline {
    margin-top: 6px;
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  /* Search area */
  .search-area {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .input-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 10px 14px;
    transition: border-color 0.15s;
  }

  .input-wrap:focus-within {
    border-color: var(--amber);
    box-shadow: 0 0 0 1px var(--amber-dim), 0 0 16px rgba(255,179,71,0.08);
  }

  .prompt-char {
    color: var(--amber);
    font-size: 15px;
    flex-shrink: 0;
    user-select: none;
  }

  #search-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--bright);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 14px;
    caret-color: var(--amber);
  }

  #search-input::placeholder {
    color: var(--muted);
    font-style: italic;
  }

  .kbd-hint {
    font-size: 10px;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 1px 5px;
    border-radius: 3px;
    flex-shrink: 0;
  }

  /* Status bar */
  .status-bar {
    padding: 6px 20px;
    font-size: 11px;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    height: 28px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .status-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--muted);
    flex-shrink: 0;
    transition: background 0.3s;
  }
  .status-dot.active { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .status-dot.loading { background: var(--amber); animation: pulse 0.8s infinite; }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* Results list */
  .results-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
  }

  .results-list::-webkit-scrollbar { width: 4px; }
  .results-list::-webkit-scrollbar-track { background: transparent; }
  .results-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .empty-state {
    padding: 40px 24px;
    text-align: center;
    color: var(--muted);
  }

  .empty-state .ascii {
    font-size: 11px;
    line-height: 1.5;
    color: #2e2b25;
    margin-bottom: 16px;
    white-space: pre;
  }

  .empty-state p { font-size: 12px; }

  .result-item {
    display: flex;
    flex-direction: column;
    gap: 3px;
    padding: 10px 20px;
    cursor: pointer;
    border-left: 2px solid transparent;
    transition: background 0.1s, border-color 0.1s;
    position: relative;
  }

  .result-item:hover,
  .result-item.active {
    background: var(--bg3);
    border-left-color: var(--amber);
  }

  .result-item.active { background: rgba(255,179,71,0.05); }

  .result-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 8px;
  }

  .result-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--bright);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
  }

  .result-name .cmd { color: var(--amber); }

  .result-section {
    font-size: 10px;
    color: var(--muted);
    flex-shrink: 0;
    border: 1px solid var(--border);
    padding: 1px 5px;
    border-radius: 2px;
    font-weight: 300;
  }

  .result-desc {
    font-size: 11px;
    color: var(--muted);
    font-style: italic;
    font-family: 'IBM Plex Mono', monospace;
    font-weight: 300;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.4;
  }

  .result-score {
    position: absolute;
    right: 20px;
    bottom: 8px;
    font-size: 9px;
    color: #2e2b25;
    font-weight: 300;
  }

  /* ── RIGHT PANEL ── */
  .right {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg);
  }

  .content-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 24px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    background: var(--bg2);
  }

  .content-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 16px;
    color: var(--bright);
    flex: 1;
  }

  .content-title .section-badge {
    display: inline-block;
    margin-left: 8px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    font-weight: 400;
    color: var(--amber);
    background: rgba(255,179,71,0.08);
    border: 1px solid var(--amber-dim);
    padding: 1px 7px;
    border-radius: 2px;
    vertical-align: middle;
  }

  .close-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 3px;
    cursor: pointer;
    transition: border-color 0.15s, color 0.15s;
  }

  .close-btn:hover { border-color: var(--red); color: var(--red); }

  .content-body {
    flex: 1;
    overflow-y: auto;
    padding: 24px 32px;
  }

  .content-body::-webkit-scrollbar { width: 5px; }
  .content-body::-webkit-scrollbar-track { background: transparent; }
  .content-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .content-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 12px;
    color: var(--muted);
  }

  .content-placeholder .big-ascii {
    font-size: 10px;
    line-height: 1.4;
    white-space: pre;
    color: #1e1c18;
    text-align: center;
  }

  .content-placeholder p {
    font-size: 12px;
    letter-spacing: 0.05em;
  }

  /* Man page text rendering */
  #man-text {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 13px;
    line-height: 1.8;
    color: var(--text);
    white-space: pre-wrap;
    word-break: break-word;
  }

  #man-text b, #man-text strong {
    color: var(--bright);
    font-weight: 600;
  }

  #man-text u, #man-text em, #man-text i {
    color: #a0c4ff;
    font-style: normal;
    text-decoration: underline;
    text-decoration-color: rgba(160,196,255,0.3);
  }

  /* Section headers in man page */
  #man-text .man-section {
    color: var(--amber);
    font-weight: 600;
    letter-spacing: 0.05em;
    display: block;
    margin-top: 1.5em;
    margin-bottom: 0.3em;
  }

  /* Loading spinner */
  .spinner {
    display: inline-block;
    width: 14px; height: 14px;
    border: 1px solid var(--border);
    border-top-color: var(--amber);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Keyboard navigation hint footer */
  .key-hints {
    padding: 8px 20px;
    font-size: 10px;
    color: #2e2b25;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 16px;
    flex-shrink: 0;
  }

  .key-hints span { letter-spacing: 0.04em; }

  /* Animations */
  .result-item {
    animation: fadeSlide 0.15s ease both;
  }

  @keyframes fadeSlide {
    from { opacity: 0; transform: translateX(-8px); }
    to   { opacity: 1; transform: translateX(0); }
  }

  /* Highlight query matches */
  .hl { color: var(--amber); background: rgba(255,179,71,0.1); border-radius: 2px; }
</style>
</head>
<body>

<div class="layout">
  <!-- LEFT: Search panel -->
  <aside class="left">
    <div class="header">
      <div class="logo">
        <span class="man">man</span><span class="slash">/</span><span>search</span>
      </div>
      <p class="tagline">Linux manual page explorer</p>
    </div>

    <div class="search-area">
      <div class="input-wrap">
        <span class="prompt-char">$</span>
        <input
          id="search-input"
          type="text"
          placeholder="copy file, list processes…"
          autocomplete="off"
          spellcheck="false"
        />
        <span class="kbd-hint">↑↓</span>
      </div>
    </div>

    <div class="status-bar">
      <span class="status-dot" id="status-dot"></span>
      <span id="status-text">ready</span>
    </div>

    <div class="results-list" id="results-list">
      <div class="empty-state">
        <p>type to search 2900+ man pages</p>
      </div>
    </div>

    <div class="key-hints">
      <span>↑↓ navigate</span>
      <span>↵ open</span>
      <span>esc close</span>
    </div>
  </aside>

  <!-- RIGHT: Content panel -->
  <main class="right">
    <div class="content-header" id="content-header" style="display:none">
      <div class="content-title" id="content-title">—</div>
      <button class="close-btn" id="close-btn">✕ close</button>
    </div>

    <div class="content-body" id="content-body">
      <div class="content-placeholder">
        <pre class="big-ascii">
        <p>| search something on the left |</p>
      </div>
    </div>
  </main>
</div>

<script>
  const input       = document.getElementById('search-input');
  const resultsList = document.getElementById('results-list');
  const statusDot   = document.getElementById('status-dot');
  const statusText  = document.getElementById('status-text');
  const contentBody = document.getElementById('content-body');
  const contentHeader = document.getElementById('content-header');
  const contentTitle  = document.getElementById('content-title');
  const closeBtn      = document.getElementById('close-btn');

  let results = [];
  let activeIdx = -1;
  let debounceTimer = null;
  let currentQuery = '';

  // ── Search ────────────────────────────────────────────────────────────────
  input.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    const q = input.value.trim();
    if (!q) { resetResults(); return; }
    debounceTimer = setTimeout(() => doSearch(q), 180);
  });

  async function doSearch(q) {
    currentQuery = q;
    setStatus('loading', 'searching…');
    try {
      const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      results = data;
      activeIdx = -1;
      renderResults(data, q);
      setStatus('active', `${data.length} result${data.length !== 1 ? 's' : ''}`);
    } catch (e) {
      setStatus('', 'error');
      resultsList.innerHTML = `<div class="empty-state"><p style="color:var(--red)">⚠ failed to fetch results</p></div>`;
    }
  }

  function resetResults() {
    results = [];
    activeIdx = -1;
    setStatus('', 'ready');
    resultsList.innerHTML = `<div class="empty-state">
      <p>type to search 2900+ man pages</p>
    </div>`;
  }

  function renderResults(data, q) {
    if (!data.length) {
          resultsList.innerHTML = `<div class="empty-state"><p>no results for <em style="color:var(--amber)">${q}</em></p></div>`;
      return;
    }

    resultsList.innerHTML = data.map((r, i) => {
      const [cmd, ...rest] = r.fname.split('.');
      const section = rest.join('.') || '';
      const desc = r.name_desc ? r.name_desc : '';
      return `<div class="result-item" data-idx="${i}" data-fname="${escAttr(r.fname)}">
        <div class="result-header">
          <div class="result-name"><span class="cmd">${hlQuery(cmd, q)}</span></div>
          ${section ? `<span class="result-section">${section}</span>` : ''}
        </div>
        ${desc ? `<div class="result-desc">${desc}</div>` : ''}
        <span class="result-score">${r.score.toFixed(1)}</span>
      </div>`;
    }).join('');

    resultsList.querySelectorAll('.result-item').forEach(el => {
      el.addEventListener('click', () => {
        const idx = parseInt(el.dataset.idx);
        setActive(idx);
        loadContent(results[idx].fname);
      });
    });
  }

  function setActive(idx) {
    resultsList.querySelectorAll('.result-item').forEach(el => el.classList.remove('active'));
    const el = resultsList.querySelector(`[data-idx="${idx}"]`);
    if (el) {
      el.classList.add('active');
      el.scrollIntoView({ block: 'nearest' });
    }
    activeIdx = idx;
  }

  async function loadContent(fname) {
    const [cmd, ...rest] = fname.split('.');
    const section = rest.join('.') || '';

    contentHeader.style.display = 'flex';
    contentTitle.innerHTML = `<b style="color:var(--amber)">${cmd}</b>${section ? `<span class="section-badge">${section}</span>` : ''}`;
    contentBody.innerHTML = `<div style="display:flex;align-items:center;gap:10px;padding:40px 0;color:var(--muted)"><span class="spinner"></span> loading man page…</div>`;

    try {
      const res = await fetch(`/api/content?fname=${encodeURIComponent(fname)}`);
      const data = await res.json();
      const formatted = formatManPage(data.text);
      contentBody.innerHTML = `<div id="man-text">${formatted}</div>`;
    } catch (e) {
      contentBody.innerHTML = `<div style="color:var(--red);padding:20px 0">⚠ failed to load content</div>`;
    }
  }

  function formatManPage(raw) {
    // The server already converts backspace formatting to <b>/<u> tags
    // We just need to style section headers
    return raw
      .split('\n')
      .map(line => {
        const trimmed = line.trim();
        // All-caps section headers (NAME, SYNOPSIS, etc.)
        if (/^[A-Z][A-Z\s_\-]{2,}$/.test(trimmed) && trimmed.length > 2) {
          return `<span class="man-section">${trimmed}</span>`;
        }
        return line;
      })
      .join('\n');
  }

  input.addEventListener('keydown', e => {
    if (!results.length) return;
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      setActive(Math.min(activeIdx + 1, results.length - 1));
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      setActive(Math.max(activeIdx - 1, 0));
    } else if (e.key === 'Enter') {
      if (activeIdx >= 0) loadContent(results[activeIdx].fname);
      else if (results.length > 0) { setActive(0); loadContent(results[0].fname); }
    }
  });

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeContent();
    if (e.key === '/' && document.activeElement !== input) { e.preventDefault(); input.focus(); }
  });

  closeBtn.addEventListener('click', closeContent);

  function closeContent() {
    contentHeader.style.display = 'none';
    contentBody.innerHTML = `<div class="content-placeholder">
      <p>← search something on the left</p>
    </div>`;
    resultsList.querySelectorAll('.result-item').forEach(el => el.classList.remove('active'));
    activeIdx = -1;
  }

  function setStatus(state, msg) {
    statusDot.className = 'status-dot' + (state ? ' ' + state : '');
    statusText.textContent = msg;
  }

  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function escAttr(s) { return s.replace(/"/g,'&quot;'); }

  function hlQuery(html, q) {
    const tokens = q.toLowerCase().split(/\s+/).filter(Boolean);
    tokens.forEach(tok => {
      const re = new RegExp(tok.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'gi');
      html = html.replace(re, m => `<span class="hl">${m}</span>`);
    });
    return html;
  }

  // Focus on load
  input.focus();
</script>
</body>
</html>
